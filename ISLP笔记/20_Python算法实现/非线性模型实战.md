---
tags:
  - Python实战
  - 非线性模型
  - 样条
  - GAM
  - PyGAM
aliases:
  - Non-linear Modeling Lab
  - Spline Code
  - GAM Code
  - 局部回归代码
---

# 非线性模型实战 (Non-linear Modeling)

## 0. 编程手核心直觉

* **从直男到曲线**：线性模型是直男，只会画直线；非线性模型学会了弯曲。
* **工具箱分层**：
    * **基础**：`PolynomialFeatures` (多项式), `pd.cut` (阶梯)。
    * **进阶**：`BSpline` (基样条), `NaturalSpline` (自然样条)。
    * **终极**：`pygam` (广义加性模型)，它是处理复杂非线性关系的“瑞士军刀”。
* **自由度 ($\lambda$ vs $df$)**：
    * 在 `pygam` 中，我们通常调整 $\lambda$ (惩罚力度)。
    * 但为了可解释性，我们常把 $\lambda$ 换算成 $df$ (有效自由度)。**记住：$df$ 越小，曲线越平滑；$df$ 越大，曲线越抖动。**

---

## 1. 基础非线性变换

**🔗 理论回溯**：[[多项式回归与阶梯函数]]

### 1.1 多项式回归 (Polynomial Regression)

不仅仅是 $X^2$，更是利用 `ANOVA` 进行模型阶数选择的标准流程。

```python
import statsmodels.api as sm
from ISLP.models import ModelSpec as MS, poly, summarize
from statsmodels.stats.anova import anova_lm

# 1. 训练不同阶数的模型 (1次到5次)
models = [MS([poly('age', degree=d)]) for d in range(1, 6)]
Xs = [model.fit_transform(Wage) for model in models]
fitted_models = [sm.OLS(y, X_) fit() for X_ in Xs]

# 2. 使用 ANOVA 检验模型显著性
# 零假设 H0: 复杂模型不比简单模型好
print(anova_lm(*fitted_models))

# 编程手注：
# 观察 Pr(>F)。如果 p < 0.05，说明增加复杂度是值得的。
# 通常 degree=3 或 4 就足够了，太高会过拟合 (Runge现象)。
```

### 1.2 阶梯函数 (Step Functions)

将连续变量“离散化”，适合处理有明显阶段性的数据（如年龄段）。

```python
# 使用 pd.qcut 按分位数切分 (保证每组样本量相等)
cut_age = pd.qcut(Wage['age'], 4)

# 自动生成 Dummy 变量并拟合
# pd.get_dummies 是处理分类变量的神器
X_step = pd.get_dummies(cut_age)
step_model = sm.OLS(y, X_step).fit()
summarize(step_model)
```

---

## 2. 样条函数 (Splines)

**🔗 理论回溯**：[[回归样条]] | [[平滑样条]]

### 2.1 基样条 vs 自然样条

- **BSpline (基样条)**：在边界处方差大，容易发散。
- **NaturalSpline (自然样条)**：强制边界线性，**MCM 推荐首选**。

```python
from ISLP.transforms import BSpline, NaturalSpline
from ISLP.models import bs, ns

# --- 基样条 (B-Spline) ---
# internal_knots: 手动指定节点位置
bs_model = MS([bs('age', internal_knots=[25, 40, 60])]).fit(Wage)

# --- 自然样条 (Natural Spline) ---
# df=5: 让算法自动按分位数选节点，凑够5个自由度
ns_model = MS([ns('age', df=5)]).fit(Wage)

# 拟合与预测
M_ns = sm.OLS(y, ns_model.transform(Wage)).fit()
```

---

## 3. 广义加性模型 (GAM)

**🔗 理论回溯**：[[广义加性模型GAM]]

这是本章的**重头戏**。我们使用 `pygam` 库来实现“多个非线性函数的叠加”。

### 3.1 核心语法速查

`pygam` 使用项 (Terms) 的加法来定义模型：

- **`s(i)` (Spline)**：对第 `i` 列特征做平滑样条。
- **`l(i)` (Linear)**：对第 `i` 列特征做线性拟合。
- **`f(i)` (Factor)**：对第 `i` 列特征做分类变量处理 (阶梯函数)。

### 3.2 模型构建与网格搜索

自动寻找最佳平滑度 ($\lambda$)。

```python
from pygam import LinearGAM, s, l, f

# 1. 定义模型结构
# Age用样条(s)，Year用样条(s)，Education用因子(f)
gam = LinearGAM(s(0) + s(1) + f(2))

# 2. 准备数据 (pygam 只吃 Numpy 数组)
X_gam = np.column_stack([
    Wage['age'], 
    Wage['year'], 
    Wage['education'].cat.codes # 必须转为数值编码
])

# 3. 自动调参 (Grid Search)
# 寻找最佳的 lambda (平滑惩罚)
gam_opt = gam.gridsearch(X_gam, y)
```

### 3.3 偏依赖图 (Partial Dependence Plots)

**论文作图神器**。展示在控制其他变量不变时，某一个变量对 $Y$ 的非线性影响。

```python
from ISLP.pygam import plot as plot_gam

fig, ax = subplots(figsize=(8, 8))

# term=0: 画第0个变量 (Age) 的影响
plot_gam(gam_opt, 0, ax=ax)

ax.set_title('Partial Dependence: Age vs Wage')
ax.set_ylabel('Effect on Wage')
# 蓝线是主效应，红虚线是 95% 置信区间
```

### 3.4 自由度与 Lambda 的转换

`pygam` 内部用 `lam`，但人类更懂 `df`。`ISLP` 提供了转换工具。

```python
from ISLP.pygam import approx_lam

# 目标：我想要 Age 这一项有 4 个自由度
age_term = gam.terms[0]
lam_4 = approx_lam(X_gam, age_term, df=4)

# 强行赋值回去
age_term.lam = lam_4
```

### 3.5 逻辑斯蒂 GAM (分类问题)

当 $Y$ 是二分类 (如 `High Earners > 250k`) 时使用。

```python
from pygam import LogisticGAM

# 排除极度不平衡的类别 (如 < HS Grad 的人几乎没有高收入)
# 否则置信区间会爆炸
gam_logit = LogisticGAM(s(0) + l(1) + f(2))
gam_logit.fit(X_train, y_class)

# 绘图逻辑同上，Y轴变为 "Log Odds" 或 "Probability"
```

---

## 4. 局部回归 (Local Regression)

**🔗 理论回溯**：[[局部回归]]

用于 EDA (探索性数据分析) 的平滑利器，不做预测，只看趋势。

```python
import statsmodels.api as sm
lowess = sm.nonparametric.lowess

# frac (span): 滑动窗口大小。
# 0.2 = 窗口占数据的 20% (波动大，拟合好)
# 0.5 = 窗口占数据的 50% (平滑，偏差大)
fitted = lowess(y, age, frac=0.2)

plt.plot(fitted[:, 0], fitted[:, 1], label='Lowess (span=0.2)')
```

---

## 5. 常见错误清单

| **现象** | **原因** | **解决方案** |
| :--- | :--- | :--- |
| **`pygam` 报错 `ValueError: string`** | `pygam` 不支持 Pandas 的字符串列。 | 使用 `.cat.codes` 或 `pd.get_dummies` 转换为数值。 |
| **GAM 曲线置信区间爆炸 (极其宽)** | 数据稀疏。该区域样本太少 (如低学历的高收入者)。 | 剔除稀疏类别或增加正则化 `lam`。 |
| **`anova_lm` 报错** | 模型未嵌套 (Nested)。 | 确保复杂模型包含简单模型的所有项。 |
| **样条在边界处乱飞** | 使用了 `BSpline` 且发生了外推。 | 改用 `NaturalSpline` (自然样条)。 |
